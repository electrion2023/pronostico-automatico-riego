name: üîß Diagn√≥stico Completo

on: workflow_dispatch

jobs:
  diagnostico:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Obtener c√≥digo
      uses: actions/checkout@v4
      
    - name: ‚éî Configurar Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: üì¶ Instalar dependencias
      run: |
        npm init -y --silent
        npm install firebase-admin axios --save
        echo "‚úÖ Dependencias instaladas"
      
    - name: üîç Verificar secrets
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_PRIVATE_KEY_ID: ${{ secrets.FIREBASE_PRIVATE_KEY_ID }}
        FIREBASE_PRIVATE_KEY: "${{ secrets.FIREBASE_PRIVATE_KEY }}"
        FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
        FIREBASE_CLIENT_ID: ${{ secrets.FIREBASE_CLIENT_ID }}
      run: |
        echo "üîê VERIFICANDO SECRETS:"
        echo "Project ID: ${FIREBASE_PROJECT_ID:0:10}..."
        echo "Private Key ID: ${FIREBASE_PRIVATE_KEY_ID:0:10}..."
        echo "Client Email: ${FIREBASE_CLIENT_EMAIL:0:10}..."
        echo "Client ID: ${FIREBASE_CLIENT_ID:0:10}..."
        echo "Private Key length: ${#FIREBASE_PRIVATE_KEY}"
        
        if [ -z "$FIREBASE_PROJECT_ID" ]; then
          echo "‚ùå FIREBASE_PROJECT_ID est√° vac√≠o"
          exit 1
        fi
        echo "‚úÖ Secrets cargados correctamente"
      
    - name: üß™ Test de Firebase
      env:
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        FIREBASE_PRIVATE_KEY_ID: ${{ secrets.FIREBASE_PRIVATE_KEY_ID }}
        FIREBASE_PRIVATE_KEY: "${{ secrets.FIREBASE_PRIVATE_KEY }}"
        FIREBASE_CLIENT_EMAIL: ${{ secrets.FIREBASE_CLIENT_EMAIL }}
        FIREBASE_CLIENT_ID: ${{ secrets.FIREBASE_CLIENT_ID }}
      run: |
        node -e "
        const admin = require('firebase-admin');
        
        console.log('üß™ INICIANDO TEST FIREBASE...');
        
        try {
          // Configuraci√≥n
          const serviceAccount = {
            type: 'service_account',
            project_id: process.env.FIREBASE_PROJECT_ID,
            private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
            private_key: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\\\n/g, '\\n'),
            client_email: process.env.FIREBASE_CLIENT_EMAIL,
            client_id: process.env.FIREBASE_CLIENT_ID
          };
          
          console.log('üîß Inicializando Firebase...');
          admin.initializeApp({
            credential: admin.credential.cert(serviceAccount),
            databaseURL: 'https://electrion-e54b2.firebaseio.com'
          });
          console.log('‚úÖ Firebase inicializado');
          
          // Test de escritura simple
          console.log('üì§ Escribiendo test en Firebase...');
          const testData = {
            test: true,
            timestamp: Date.now(),
            message: 'Test desde diagn√≥stico',
            random: Math.random()
          };
          
          const db = admin.database();
          await db.ref('/test_diagnostico').set(testData);
          console.log('‚úÖ Escritura exitosa en Firebase');
          console.log('üìù Datos escritos:', JSON.stringify(testData, null, 2));
          
          // Verificar lectura
          console.log('üìñ Leyendo datos de Firebase...');
          const snapshot = await db.ref('/test_diagnostico').once('value');
          const data = snapshot.val();
          console.log('‚úÖ Lectura exitosa:', JSON.stringify(data, null, 2));
          
          console.log('üéâ TODAS LAS PRUEBAS EXITOSAS');
          process.exit(0);
          
        } catch (error) {
          console.error('‚ùå ERROR EN TEST FIREBASE:');
          console.error('Mensaje:', error.message);
          console.error('C√≥digo:', error.code || 'N/A');
          if (error.stack) {
            console.error('Stack:', error.stack.split('\\n')[0]);
          }
          process.exit(1);
        }
        "
